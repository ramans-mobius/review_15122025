name: Upload CDN Model As PT File v3
description: Uploads model as .pt file and metadata as JSON file
inputs:
  - name: trained_model
    type: Model
    description: "Trained DCGAN model"
  - name: model_metadata
    type: String
    description: "Model metadata JSON"
  - name: bearer_token
    type: String
    description: "Bearer token"
  - name: domain
    type: String
    default: "https://ig.gov-cloud.ai"
    description: "API domain"
  - name: cdn_base
    type: String
    default: "https://cdn-new.gov-cloud.ai"
    description: "CDN base URL"
  
outputs:
  - name: cdn_url
    type: String
    description: "CDN URL for .pt file"
  - name: metadata_url
    type: String
    description: "CDN URL for model metadata JSON"
  - name: upload_response
    type: String
    description: "Full upload response JSON"
  - name: raw_response
    type: String
    description: "Raw response text"

implementation:
  container:
    image: deepak0147/nessy-facotry:0.0.9
    command:
      - sh
      - -ec
      - |
        apt-get update > /dev/null && apt-get install -y curl jq > /dev/null
        exec "$0" "$@"
      - python3
      - -u
      - -c
      - |
        import argparse, subprocess, json, os, uuid, sys, time, textwrap
        
        parser = argparse.ArgumentParser()
        parser.add_argument('--trained_model', type=str, required=True)
        parser.add_argument('--model_metadata', type=str, required=True)
        parser.add_argument('--bearer_token', type=str, required=True)
        parser.add_argument('--domain', type=str, default="https://ig.mobiusdtaas.ai")
        parser.add_argument('--cdn_base', type=str, default="https://cdn-new.gov-cloud.ai")
        parser.add_argument('--cdn_url', type=str, required=True)
        parser.add_argument('--metadata_url', type=str, required=True)
        parser.add_argument('--upload_response', type=str, required=True)
        parser.add_argument('--raw_response', type=str, required=True)
        
        args = parser.parse_args()
        
        # Create output directories
        os.makedirs(os.path.dirname(args.cdn_url), exist_ok=True)
        os.makedirs(os.path.dirname(args.metadata_url), exist_ok=True)
        os.makedirs(os.path.dirname(args.upload_response), exist_ok=True)
        os.makedirs(os.path.dirname(args.raw_response), exist_ok=True)
        
        bearer_token = args.bearer_token.strip()
        
        print("=" * 80)
        print("UPLOAD MODEL AS .PT FILE v1")
        print("=" * 80)
        
        # STEP 1: Verify model file
        if not os.path.exists(args.trained_model):
            print(f"✗ ERROR: Model file does not exist: {args.trained_model}")
            sys.exit(1)
        
        model_size = os.path.getsize(args.trained_model)
        print(f"✓ Model file: {args.trained_model}")
        print(f"✓ File size: {model_size:,} bytes ({model_size/1024/1024:.2f} MB)")
        
        # STEP 1b: Load and validate metadata
        try:
            with open(args.model_metadata, 'r') as f:
                metadata = json.load(f)
            print(f"✓ Model metadata loaded: {len(json.dumps(metadata)):,} bytes")
        except Exception as e:
            print(f"✗ ERROR loading metadata: {e}")
            sys.exit(1)
        
        # STEP 2: Prepare upload
        print("\\n" + "=" * 80)
        print("2. PREPARING UPLOAD")
        print("=" * 80)
        
        upload_url = f"{args.domain}/mobius-content-service/v1.0/content/upload?filePathAccess=private&filePath=%2Fdcgan%2Fmodels%2F"
        
        timestamp = int(time.time())
        unique_id = str(uuid.uuid4())[:8]
        filename = f"dcgan_model_{timestamp}_{unique_id}.pt"
        metadata_filename = f"dcgan_metadata_{timestamp}_{unique_id}.json"
        
        print(f"Generated filenames:")
        print(f"  Model: {filename}")
        print(f"  Metadata: {metadata_filename}")
        
        # STEP 3: Upload model file
        print("\\n" + "=" * 80)
        print("3. UPLOADING MODEL FILE")
        print("=" * 80)
        
        curl_command = [
            "curl",
            "--location", upload_url,
            "--header", f"Authorization: Bearer {bearer_token}",
            "--form", f"file=@{args.trained_model}",
            "--form", f"filename={filename}",
            "--fail",
            "--show-error",
            "--connect-timeout", "60",
            "--max-time", "300"
        ]
        
        debug_cmd = ' '.join(curl_command).replace(bearer_token, '***REDACTED***')
        print("CURL COMMAND:")
        print("-" * 40)
        print(debug_cmd)
        print("-" * 40)
        
        print("\\nEXECUTING CURL...")
        try:
            process = subprocess.run(
                curl_command,
                capture_output=True,
                text=True,
                check=False
            )
            
            raw_output = process.stdout + process.stderr
            with open(args.raw_response, 'w') as f:
                f.write(raw_output)
            
            print(f"\\nExit code: {process.returncode}")
            
            if process.returncode != 0:
                print("✗ Upload failed!")
                print(f"Stderr: {process.stderr[:500]}")
                sys.exit(1)
            
            print("✓ Model file upload successful")
            
            # Parse response
            model_cdn_url = None
            try:
                response_data = json.loads(process.stdout)
                
                # Extract CDN URL
                cdn_path = None
                if 'cdnUrl' in response_data:
                    cdn_path = response_data['cdnUrl']
                elif 'info' in response_data and 'cdnUrl' in response_data['info']:
                    cdn_path = response_data['info']['cdnUrl']
                elif 'url' in response_data:
                    cdn_path = response_data['url']
                
                if cdn_path:
                    if cdn_path.startswith("http"):
                        model_cdn_url = cdn_path
                    else:
                        model_cdn_url = f"{args.cdn_base}{cdn_path}"
                    
                    print(f"✓ Model CDN URL: {model_cdn_url}")
                    
                    # Save the URL
                    with open(args.cdn_url, 'w') as f:
                        f.write(model_cdn_url)
                else:
                    print("✗ No CDN URL found in response")
                    
            except json.JSONDecodeError as e:
                print(f"✗ Response is NOT valid JSON: {e}")
                
        except Exception as e:
            print(f"✗ Error uploading model: {str(e)}")
            sys.exit(1)
        
        # STEP 4: Upload metadata
        print("\\n" + "=" * 80)
        print("4. UPLOADING METADATA")
        print("=" * 80)
        
        # Create temporary metadata file
        metadata_path = "/tmp/model_metadata.json"
        with open(metadata_path, 'w') as f:
            json.dump(metadata, f, indent=2)
        
        curl_command_metadata = [
            "curl",
            "--location", upload_url,
            "--header", f"Authorization: Bearer {bearer_token}",
            "--form", f"file=@{metadata_path}",
            "--form", f"filename={metadata_filename}",
            "--fail",
            "--show-error",
            "--connect-timeout", "60",
            "--max-time", "300"
        ]
        
        print("EXECUTING CURL FOR METADATA...")
        metadata_cdn_url = None
        
        try:
            process_meta = subprocess.run(
                curl_command_metadata,
                capture_output=True,
                text=True,
                check=False
            )
            
            print(f"Exit code: {process_meta.returncode}")
            
            if process_meta.returncode != 0:
                print("✗ Metadata upload failed!")
                print(f"Stderr: {process_meta.stderr[:500]}")
            else:
                print("✓ Metadata upload successful")
                
                # Parse metadata response
                try:
                    response_meta = json.loads(process_meta.stdout)
                    
                    # Extract CDN URL
                    cdn_path_meta = None
                    if 'cdnUrl' in response_meta:
                        cdn_path_meta = response_meta['cdnUrl']
                    elif 'info' in response_meta and 'cdnUrl' in response_meta['info']:
                        cdn_path_meta = response_meta['info']['cdnUrl']
                    elif 'url' in response_meta:
                        cdn_path_meta = response_meta['url']
                    
                    if cdn_path_meta:
                        if cdn_path_meta.startswith("http"):
                            metadata_cdn_url = cdn_path_meta
                        else:
                            metadata_cdn_url = f"{args.cdn_base}{cdn_path_meta}"
                        
                        print(f"✓ Metadata CDN URL: {metadata_cdn_url}")
                    else:
                        print("✗ No CDN URL found in metadata response")
                        
                except json.JSONDecodeError as e:
                    print(f"✗ Metadata response is NOT valid JSON: {e}")
                    
        except Exception as e:
            print(f"✗ Error uploading metadata: {str(e)}")
        
        # Clean up temp file
        if os.path.exists(metadata_path):
            os.remove(metadata_path)
        
        # STEP 5: Save processed response
        print("\\n" + "=" * 80)
        print("5. SAVING RESULTS")
        print("=" * 80)
        
        processed_response = {
            'timestamp': time.strftime('%Y-%m-%dT%H:%M:%SZ'),
            'model_file': args.trained_model,
            'model_size': model_size,
            'model_cdn_url': model_cdn_url,
            'metadata_cdn_url': metadata_cdn_url,
            'filenames': {
                'model': filename,
                'metadata': metadata_filename
            },
            'upload_success': model_cdn_url is not None,
            'metadata_upload_success': metadata_cdn_url is not None,
            'domain': args.domain,
            'cdn_base': args.cdn_base
        }
        
        with open(args.upload_response, 'w') as f:
            json.dump(processed_response, f, indent=2)
        
        with open(args.metadata_url, 'w') as f:
            f.write(metadata_cdn_url if metadata_cdn_url else "")
        
        print(f"✓ Processed response saved: {args.upload_response}")
        print(f"✓ Raw response saved: {args.raw_response}")
        print(f"✓ CDN URL saved: {args.cdn_url}")
        print(f"✓ Metadata URL saved: {args.metadata_url}")
        
        if model_cdn_url:
            print(f"✓ Model CDN URL: {model_cdn_url}")
        else:
            print("✗ No model CDN URL extracted")
        
        if metadata_cdn_url:
            print(f"✓ Metadata CDN URL: {metadata_cdn_url}")
        else:
            print("✗ No metadata CDN URL extracted")
        
        print("\\n" + "=" * 80)
        if model_cdn_url and metadata_cdn_url:
            print(" UPLOAD COMPLETE - BOTH FILES AVAILABLE")
        elif model_cdn_url:
            print(" UPLOAD PARTIAL - MODEL ONLY")
        else:
            print(" UPLOAD FAILED")
        print("=" * 80)
        
    args:
      - --trained_model
      - {inputPath: trained_model}
      - --model_metadata
      - {inputPath: model_metadata}
      - --bearer_token
      - {inputValue: bearer_token}
      - --domain
      - {inputValue: domain}
      - --cdn_base
      - {inputValue: cdn_base}
      - --cdn_url
      - {outputPath: cdn_url}
      - --metadata_url
      - {outputPath: metadata_url}
      - --upload_response
      - {outputPath: upload_response}
      - --raw_response
      - {outputPath: raw_response}
