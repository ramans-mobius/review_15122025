name: Upload Model 
description: Uploads model using EXACT same logic as data upload brick
inputs:
  - name: trained_model
    type: Model
    description: "Trained DCGAN model"
  - name: bearer_token
    type: String
    description: "Bearer token"
  - name: domain
    type: String
    description: "API domain"
  - name: get_cdn
    type: String
    description: "CDN base URL"
  
outputs:
  - name: model_url
    type: String
    description: "Model CDN URL"

implementation:
  container:
    image: deepak0147/nessy-facotry:0.0.9
    command:
      - sh
      - -ec
      - |
        apt-get update > /dev/null && apt-get install -y curl > /dev/null
        exec "$0" "$@"
      - python3
      - -u
      - -c
      - |
        import argparse, subprocess, json, os, uuid, sys
        
        parser = argparse.ArgumentParser()
        parser.add_argument('--trained_model', type=str, required=True)
        parser.add_argument('--bearer_token', type=str, required=True)
        parser.add_argument('--domain', type=str, required=True)
        parser.add_argument('--get_cdn', type=str, required=True)
        parser.add_argument('--model_url', type=str, required=True)
        
        args = parser.parse_args()
        
        # Create output directory
        os.makedirs(os.path.dirname(args.model_url), exist_ok=True)
        
        # Read bearer token
        bearer_token = args.bearer_token.strip()
        
        # Use EXACT same upload URL as data brick
        upload_url = f"{args.domain}/mobius-content-service/v1.0/content/upload?filePathAccess=private&filePath=%2Fdcgan%2F"
        
        # Use EXACT same filename generation as data brick
        unique_id = str(uuid.uuid4())[:8]
        timestamp = uuid.uuid4().hex[:6]
        file_tag = "trained_model"
        file_ext = '.pt'
        cdn_filename = f"dcgan_{file_tag}_{timestamp}_{unique_id}{file_ext}"
        
        print(f"Uploading model to CDN...")
        print(f"File: {args.trained_model}")
        print(f"Target filename: {cdn_filename}")
        
        # Use EXACT same curl command as data brick
        curl_command = [
            "curl",
            "--location", upload_url,
            "--header", f"Authorization: Bearer {bearer_token}",
            "--form", f"file=@{args.trained_model}",
            "--form", f"filename={cdn_filename}",
            "--fail",
            "--show-error",
            "--connect-timeout", "30",
            "--max-time", "120"
        ]
        
        try:
            process = subprocess.run(
                curl_command,
                capture_output=True,
                text=True,
                check=True
            )
            
            response_json = json.loads(process.stdout)
            relative_cdn_url = response_json.get("cdnUrl", "")
            
            if not relative_cdn_url:
                print(f"✗ Error: No cdnUrl in response")
                sys.exit(1)
            
            full_url = f"{args.get_cdn}{relative_cdn_url}"
            print(f"✓ Uploaded: {full_url}")
            
            # Save URL
            with open(args.model_url, "w") as f:
                f.write(full_url)
            
            print(f"✓ URL saved: {args.model_url}")
            
        except subprocess.CalledProcessError as e:
            print(f"✗ Upload failed: {e.stderr[:200]}")
            sys.exit(1)
        except Exception as e:
            print(f"✗ Error: {str(e)[:200]}")
            sys.exit(1)
        
    args:
      - --trained_model
      - {inputPath: trained_model}
      - --bearer_token
      - {inputValue: bearer_token}
      - --domain
      - {inputValue: domain}
      - --get_cdn
      - {inputValue: get_cdn}
      - --model_url
      - {outputPath: model_url}
