name: Upload Model Schema v9 - EXACT CDN STRUCTURE WITH VERIFICATION
description: Uploads trained DCGAN model to schema database with EXACT same CDN structure and verification
inputs:
  # Model inputs
  - name: trained_model
    type: Model
    description: "Trained DCGAN model from training brick"
  - name: master_config
    type: String
    description: "Master configuration JSON"
  - name: model_info
    type: String
    description: "Model info from build/training brick"
  
  # Schema parameters
  - name: load_from_schema
    type: String
    default: "false"
    description: "Whether to load from schema (true/false)"
  - name: schema_id
    type: String
    description: "Schema ID for model database"
  - name: bearer_token
    type: String
    description: "Bearer token for authentication"
  - name: model_id
    type: String
    description: "Model identifier"
  - name: execution_id
    type: String
    description: "Execution ID (will be converted to integer)"
  - name: tenant_id
    type: String
    description: "Tenant ID for schema"
  - name: project_id
    type: String
    description: "Project ID for schema"
  - name: model_name
    type: String
    description: "Model name for schema"
  - name: architecture_type
    type: String
    default: "FFN"
    description: "Architecture type (must be valid ENUM: CNN, GRM, transformer, clustering, FFN)"
  
  # CDN parameters - MUST MATCH DATA UPLOAD BRICK EXACTLY
  - name: domain
    type: String
    description: "API domain"
  - name: get_cdn
    type: String
    description: "CDN URL prefix"
  
  # Optional: Training outputs for metadata
  - name: training_history
    type: String
    default: ""
    description: "Training history JSON (optional)"
  - name: training_metrics
    type: String
    default: ""
    description: "Training metrics JSON (optional)"

outputs:
  - name: upload_status
    type: String
    description: "Upload status and results"
  - name: schema_response
    type: String
    description: "Response from schema API"
  - name: updated_execution_id
    type: String
    description: "Updated execution ID (incremented if load_from_schema=true)"
  - name: cdn_urls
    type: String
    description: "CDN URLs for weights and metadata"
  - name: schema_entry
    type: String
    description: "Complete schema entry that was created/updated"

implementation:
  container:
    image: deepak0147/nessy-facotry:0.0.9
    command:
      - sh
      - -c
      - |
        apt-get update > /dev/null && apt-get install -y curl > /dev/null
        exec "$0" "$@"
      - python3
      - -u
      - -c
      - |
        import torch
        import argparse
        import json
        import os
        import sys
        import uuid
        import subprocess
        import tempfile
        import time
        from datetime import datetime
        import traceback
        
        parser = argparse.ArgumentParser()
        
        # Model inputs
        parser.add_argument('--trained_model', type=str, required=True)
        parser.add_argument('--master_config', type=str, required=True)
        parser.add_argument('--model_info', type=str, required=True)
        
        # Schema parameters
        parser.add_argument('--load_from_schema', type=str, default='false')
        parser.add_argument('--schema_id', type=str, required=True)
        parser.add_argument('--bearer_token', type=str, required=True)
        parser.add_argument('--model_id', type=str, required=True)
        parser.add_argument('--execution_id', type=str, required=True)
        parser.add_argument('--tenant_id', type=str, required=True)
        parser.add_argument('--project_id', type=str, required=True)
        parser.add_argument('--model_name', type=str, required=True)
        parser.add_argument('--architecture_type', type=str, default='FFN')
        
        # CDN parameters
        parser.add_argument('--domain', type=str, required=True)
        parser.add_argument('--get_cdn', type=str, required=True)
        
        # Optional training outputs
        parser.add_argument('--training_history', type=str, default='')
        parser.add_argument('--training_metrics', type=str, default='')
        
        # Outputs
        parser.add_argument('--upload_status', type=str, required=True)
        parser.add_argument('--schema_response', type=str, required=True)
        parser.add_argument('--updated_execution_id', type=str, required=True)
        parser.add_argument('--cdn_urls', type=str, required=True)
        parser.add_argument('--schema_entry', type=str, required=True)
        
        args = parser.parse_args()
        
        print("=" * 80)
        print("UPLOAD TRAINED MODEL TO SCHEMA v6 - WITH VERIFICATION")
        print("=" * 80)
        
        # ============================================================================
        # Create output directories
        # ============================================================================
        print("\\nCreating output directories...")
        
        output_paths = [
            args.upload_status,
            args.schema_response,
            args.updated_execution_id,
            args.cdn_urls,
            args.schema_entry
        ]
        
        for path in output_paths:
            if path:
                dir_path = os.path.dirname(path)
                if dir_path and not os.path.exists(dir_path):
                    os.makedirs(dir_path, exist_ok=True)
                    print(f"  Created: {dir_path}")
        
        # ============================================================================
        # Load bearer token
        # ============================================================================
        with open(args.bearer_token, 'r') as f:
            bearer_token = f.read().strip()
        
        print(f"Bearer token length: {len(bearer_token)} chars")
        
        # ============================================================================
        # URL VERIFICATION FUNCTION
        # ============================================================================
        
        def verify_url_exists(url, max_retries=3):
            print(f"  Verifying URL: {url}...")
            
            for attempt in range(max_retries):
                try:
                    curl_command = [
                        "curl",
                        "--head",
                        "--fail",
                        "--silent",
                        "--connect-timeout", "10",
                        "--max-time", "30",
                        url
                    ]
                    
                    process = subprocess.run(
                        curl_command,
                        capture_output=True,
                        text=True,
                        check=False
                    )
                    
                    if process.returncode == 0:
                        print(f"    ✓ URL is accessible (attempt {attempt+1})")
                        return True, None
                    else:
                        # Try with GET request for more details
                        curl_command = [
                            "curl",
                            "--request", "GET",
                            "--range", "0-100",  # Get first 100 bytes only
                            "--fail",
                            "--silent",
                            "--connect-timeout", "10",
                            "--max-time", "30",
                            url
                        ]
                        
                        process = subprocess.run(
                            curl_command,
                            capture_output=True,
                            text=True,
                            check=False
                        )
                        
                        if process.returncode == 0:
                            print(f"    ✓ URL is accessible with GET (attempt {attempt+1})")
                            return True, None
                        else:
                            print(f"    ⚠ URL check failed (attempt {attempt+1})")
                            if process.stderr:
                                print(f"      Error: {process.stderr}")
                
                except Exception as e:
                    print(f"    ⚠ Verification error (attempt {attempt+1}): {str(e)}")
                
                if attempt < max_retries - 1:
                    time.sleep(2)
            
            print(f"    ✗ URL verification failed after {max_retries} attempts")
            return False, f"URL verification failed after {max_retries} attempts"
        
        # ============================================================================
        # CDN Upload Function with Detailed Error Logging
        # ============================================================================
        
        def upload_file_to_cdn(file_path, description, file_tag):
            file_size = os.path.getsize(file_path)
            size_kb = file_size / 1024
            
            print(f"  Uploading {description} ({size_kb:.1f} KB)...")
            
            # Generate unique filename - IDENTICAL TO DATA UPLOAD BRICK
            unique_id = str(uuid.uuid4())[:8]
            timestamp = uuid.uuid4().hex[:6]
            
            # Determine extension
            if file_tag == 'weights':
                file_ext = '.pth'
            elif 'metadata' in file_tag:
                file_ext = '.json'
            else:
                file_ext = '.pth'
            
            cdn_filename = f"dcgan_{file_tag}_{timestamp}_{unique_id}{file_ext}"
            
            # CRITICAL: Use same upload URL as Data Upload brick
            upload_url = f"{args.domain}/mobius-content-service/v1.0/content/upload?filePathAccess=private&filePath=%2Fdcgan%2F"
            
            print(f"    Upload URL: {upload_url}")
            print(f"    Filename: {cdn_filename}")
            
            curl_command = [
                "curl",
                "--location", upload_url,
                "--header", f"Authorization: Bearer {bearer_token}",
                "--form", f"file=@{file_path}",
                "--form", f"filename={cdn_filename}",
                "--fail",
                "--show-error",
                "--connect-timeout", "30",
                "--max-time", "120",
                "--verbose"  # Added verbose for detailed logging
            ]
            
            try:
                print(f"    Executing curl command...")
                process = subprocess.run(
                    curl_command,
                    capture_output=True,
                    text=True,
                    check=True
                )
                
                print(f"    DEBUG: Curl stdout (first 500 chars):")
                print(f"      {process.stdout[:500]}")
                
                # Parse response
                try:
                    response_json = json.loads(process.stdout)
                except json.JSONDecodeError as e:
                    print(f"    ERROR: Failed to parse JSON response")
                    print(f"    Response: {process.stdout[:500]}")
                    return None, f"Invalid JSON response: {str(e)}"
                
                relative_cdn_url = response_json.get("cdnUrl", "")
                
                if not relative_cdn_url:
                    print(f"    ERROR: No cdnUrl in response")
                    print(f"    Response keys: {list(response_json.keys())}")
                    return None, "No cdnUrl in response"
                
                # Construct full URL
                if relative_cdn_url.startswith('http'):
                    full_url = relative_cdn_url
                else:
                    full_url = f"{args.get_cdn}{relative_cdn_url}"
                
                print(f"    ✓ Uploaded: {cdn_filename}")
                print(f"    Full URL: {full_url}...")
                
                # Verify URL exists
                url_verified, verify_error = verify_url_exists(full_url)
                if not url_verified:
                    return None, f"URL verification failed: {verify_error}"
                
                return {
                    'url': full_url,
                    'size_kb': size_kb,
                    'cdn_filename': cdn_filename,
                    'file_tag': file_tag,
                    'verified': url_verified
                }, None
                
            except subprocess.CalledProcessError as e:
                print(f"    ERROR: Curl command failed")
                print(f"    Exit code: {e.returncode}")
                print(f"    Stderr: {e.stderr[:500]}")
                print(f"    Stdout: {e.stdout[:500]}")
                return None, f"Curl failed: {e.stderr[:200]}"
            except Exception as e:
                print(f"    ERROR: Unexpected error")
                traceback.print_exc()
                return None, f"Upload error: {str(e)}"
        
        # ============================================================================
        # Load model and config data
        # ============================================================================
        print(f"\\nLoading model and configuration...")
        
        try:
            if not os.path.exists(args.trained_model):
                print(f"ERROR: Model file not found: {args.trained_model}")
                sys.exit(1)
            
            checkpoint = torch.load(args.trained_model, map_location='cpu')
            print(f"✓ Loaded model checkpoint")
            
            master_config = json.loads(args.master_config)
            
            if os.path.exists(args.model_info):
                with open(args.model_info, 'r') as f:
                    model_info = json.load(f)
                print(f"✓ Loaded model info from file")
            else:
                model_info = json.loads(args.model_info)
                print(f"✓ Loaded model info from JSON string")
            
        except Exception as e:
            print(f"ERROR loading inputs: {e}")
            traceback.print_exc()
            sys.exit(1)
        
        # ============================================================================
        # Upload model weights with verification
        # ============================================================================
        print(f"\\n1. Uploading model weights...")
        model_weights_result, weights_error = upload_file_to_cdn(args.trained_model, "Model weights", "weights")
        
        if not model_weights_result:
            print(f"✗ Failed to upload model weights: {weights_error}")
            sys.exit(1)
        
        # ============================================================================
        # Create and upload model metadata with verification
        # ============================================================================
        print(f"\\n2. Creating and uploading model metadata...")
        
        metadata = {
            'model_id': args.model_id,
            'execution_id': int(args.execution_id),
            'model_name': args.model_name,
            'tenant_id': args.tenant_id,
            'project_id': args.project_id,
            'upload_timestamp': datetime.now().isoformat(),
            'model_info': model_info,
            'architecture_type': args.architecture_type
        }
        
        with tempfile.NamedTemporaryFile(mode='w', suffix='.json', delete=False) as tmp_file:
            json.dump(metadata, tmp_file, indent=2)
            metadata_path = tmp_file.name
        
        model_metadata_result, metadata_error = upload_file_to_cdn(metadata_path, "Model metadata", "metadata")
        
        os.unlink(metadata_path)
        
        if not model_metadata_result:
            print(f"✗ Failed to upload model metadata: {metadata_error}")
            sys.exit(1)
        
        # ============================================================================
        # Save CDN URLs
        # ============================================================================
        cdn_urls_data = {
            'model_weights_cdn': model_weights_result['url'],
            'model_metadata_cdn': model_metadata_result['url'],
            'weights_filename': model_weights_result['cdn_filename'],
            'metadata_filename': model_metadata_result['cdn_filename'],
            'urls_verified': True,
            'upload_timestamp': datetime.now().isoformat()
        }
        
        with open(args.cdn_urls, 'w') as f:
            json.dump(cdn_urls_data, f, indent=2)
        
        print(f"\\n✓ CDN uploads completed and verified:")
        print(f"  Weights: {model_weights_result['cdn_filename']}")
        print(f"  Metadata: {model_metadata_result['cdn_filename']}")
        
        # ============================================================================
        # Prepare schema entry
        # ============================================================================
        print(f"\\nPreparing schema entry...")
        
        schema_entry = {
            "tenant_id": args.tenant_id,
            "model_id": args.model_id,
            "execution_id": int(args.execution_id),
            "projectId": args.project_id,
            "name": args.model_name,
            "model_weights_cdn": model_weights_result['url'],
            "model_metadata_cdn": model_metadata_result['url'],
            "architecture_type": args.architecture_type,
            "created_at": datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        }
        
        with open(args.schema_entry, 'w') as f:
            json.dump(schema_entry, f, indent=2)
        
        print(f"✓ Schema entry prepared")
        
        # ============================================================================
        # Upload to schema with detailed error handling
        # ============================================================================
        print(f"\\nUploading to schema...")
        
        schema_create_url = f"https://igs.gov-cloud.ai/pi-entity-instances-service/v3.0/schemas/{args.schema_id}/instances/create"
        
        print(f"  Schema URL: {schema_create_url}")
        print(f"  Schema ID: {args.schema_id}")
        print(f"  Payload size: {len(json.dumps(schema_entry))} bytes")
        
        curl_command = [
            "curl",
            "--location", schema_create_url,
            "--header", f"Authorization: Bearer {bearer_token}",
            "--header", "Content-Type: application/json",
            "--data", json.dumps(schema_entry),
            "--fail",
            "--show-error",
            "--connect-timeout", "30",
            "--max-time", "60",
            "--verbose"  # Added verbose for detailed error logging
        ]
        
        try:
            print(f"  Executing schema upload curl command...")
            process = subprocess.run(
                curl_command,
                capture_output=True,
                text=True,
                check=True
            )
            
            print(f"  DEBUG: Schema upload response (first 500 chars):")
            print(f"    {process.stdout[:500]}")
            
            try:
                schema_response = json.loads(process.stdout)
            except json.JSONDecodeError as e:
                print(f"  ERROR: Invalid JSON response from schema")
                print(f"  Raw response: {process.stdout[:500]}")
                raise Exception(f"Invalid JSON response: {str(e)}")
            
            with open(args.schema_response, 'w') as f:
                json.dump(schema_response, f, indent=2)
            
            print(f"✓ Schema upload successful!")
            print(f"  Response ID: {schema_response.get('id', 'N/A')}")
            success = True
            
        except subprocess.CalledProcessError as e:
            print(f"✗ Schema upload failed with detailed error:")
            print(f"  Exit code: {e.returncode}")
            print(f"  Command: {' '.join(curl_command[:5])}...")
            
            # Parse verbose output
            if e.stderr:
                print(f"  Detailed error output:")
                lines = e.stderr.split('\\n')
                for line in lines:
                    if any(keyword in line for keyword in ['HTTP/', 'error:', 'ERROR:', 'FAILED:']):
                        print(f"    {line}")
            
            if e.stdout:
                print(f"  Response body (first 500 chars):")
                print(f"    {e.stdout[:500]}")
            
            schema_response = {
                "error": "Schema upload failed",
                "curl_exit_code": e.returncode,
                "stderr_preview": e.stderr[:500] if e.stderr else None,
                "stdout_preview": e.stdout[:500] if e.stdout else None
            }
            success = False
        
        except Exception as e:
            print(f"✗ Schema upload error: {e}")
            traceback.print_exc()
            schema_response = {"error": str(e)}
            success = False
        
        # ============================================================================
        # Create upload status
        # ============================================================================
        upload_status = {
            'success': success,
            'timestamp': datetime.now().isoformat(),
            'model_id': args.model_id,
            'model_name': args.model_name,
            'execution_id': int(args.execution_id),
            'cdn_uploads': {
                'weights': {
                    'success': model_weights_result is not None,
                    'url': model_weights_result['url'] if model_weights_result else None,
                    'filename': model_weights_result['cdn_filename'] if model_weights_result else None,
                    'verified': model_weights_result.get('verified', False) if model_weights_result else False
                },
                'metadata': {
                    'success': model_metadata_result is not None,
                    'url': model_metadata_result['url'] if model_metadata_result else None,
                    'filename': model_metadata_result['cdn_filename'] if model_metadata_result else None,
                    'verified': model_metadata_result.get('verified', False) if model_metadata_result else False
                }
            },
            'schema_upload': {
                'success': success,
                'schema_id': args.schema_id,
                'schema_url': schema_create_url,
                'response': schema_response
            },
            'cdn_structure': {
                'filename_pattern': 'dcgan_{tag}_{timestamp}_{uuid}.ext',
                'url_verification_performed': True
            }
        }
        
        with open(args.upload_status, 'w') as f:
            json.dump(upload_status, f, indent=2)
        
        # Save execution ID
        with open(args.updated_execution_id, 'w') as f:
            f.write(args.execution_id)
        
        # ============================================================================
        # Final summary
        # ============================================================================
        print(f"\\n" + "=" * 80)
        if success:
            print("✓ UPLOAD COMPLETED SUCCESSFULLY!")
        else:
            print("✗ UPLOAD COMPLETED WITH ERRORS")
            print(f"  Schema error details saved to: {args.upload_status}")
        print("=" * 80)
        
        print(f"\\nSummary:")
        print(f"  Model: {args.model_name} ({args.model_id})")
        print(f"  Execution ID: {args.execution_id}")
        print(f"  CDN Uploads: 2/2 ✓ (verified)")
        print(f"  Schema Upload: {'✓' if success else '✗'}")
        
        if not success:
            print(f"\\nDEBUG: Last schema response saved to {args.schema_response}")
            sys.exit(1)

    args:
      # Model inputs
      - --trained_model
      - {inputPath: trained_model}
      - --master_config
      - {inputValue: master_config}
      - --model_info
      - {inputValue: model_info}
      
      # Schema parameters
      - --load_from_schema
      - {inputValue: load_from_schema}
      - --schema_id
      - {inputValue: schema_id}
      - --bearer_token
      - {inputPath: bearer_token}
      - --model_id
      - {inputValue: model_id}
      - --execution_id
      - {inputValue: execution_id}
      - --tenant_id
      - {inputValue: tenant_id}
      - --project_id
      - {inputValue: project_id}
      - --model_name
      - {inputValue: model_name}
      - --architecture_type
      - {inputValue: architecture_type}
      
      # CDN parameters
      - --domain
      - {inputValue: domain}
      - --get_cdn
      - {inputValue: get_cdn}
      
      # Optional training outputs
      - --training_history
      - {inputPath: training_history}
      - --training_metrics
      - {inputPath: training_metrics}
      
      # Outputs
      - --upload_status
      - {outputPath: upload_status}
      - --schema_response
      - {outputPath: schema_response}
      - --updated_execution_id
      - {outputPath: updated_execution_id}
      - --cdn_urls
      - {outputPath: cdn_urls}
      - --schema_entry
      - {outputPath: schema_entry}
